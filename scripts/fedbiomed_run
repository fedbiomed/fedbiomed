#!/bin/bash
#
# run a specific component of fedbiomed
#

# detect how the file is run
([[ -n $ZSH_EVAL_CONTEXT && $ZSH_EVAL_CONTEXT =~ :file$ ]] ||
 [[ -n $KSH_VERSION && $(cd "$(dirname -- "$0")" &&
    printf '%s' "${PWD%/}/")$(basename -- "$0") != "${.sh.file}" ]] ||
 [[ -n $BASH_VERSION ]] && (return 0 2>/dev/null)) && sourced=1 || sourced=0

[[ "${sourced}" == "1" ]] && echo "This file MUST NOT be sourced" && return

#Activate conda with any of the next commands
#source ~/miniconda3/bin/activate
#source ~/.bashrc

eval "$(conda shell.bash hook)"

#
# find the directory containing all sources
#
#
basedir=$(cd $(dirname $0)/.. || exit ; pwd)
cd $basedir || exit



# Colors
RED='\033[0;31m' #red
YLW='\033[1;33m' #yellow
NC='\033[0m' #no color

# Default GUI host and port variables
GUI_HOST="localhost"
GUI_PORT="8484"
GUI_DEBUG=False
# Script for starting GUI
function start_gui() {
    # Check config file status
    if [ -n "$CONFIG_FILE" ]; then
      echo -e "${YLW}INFO${NC}: Using $CONFIG_FILE file as GUI node config"
    else
      CONFIG_FILE="config_node.ini"
      echo -e "${YLW}INFO${NC}: Config file has not been provided, default config 'config_node.ini' will be used for GUI"
    fi

    # Configure data path
    if [ ! -n "$DATA_PATH" ]; then
      DATA_PATH="data"
      echo -e "${YLW}INFO${NC}: Data path has not been provided. Trying to use \${FEDBIOMED_ROOT}/data dir"
      if [ ! -d "$basedir/$DATA_PATH" ]; then
        echo "ERROR: 'data' folder does not exist in Fed-BioMed root"
        exit 1
      fi
    else
        # If the path is absolute
        if [[ $DATA_PATH == /* ]]; then
            if [[ ! -d "$DATA_PATH" ]]; then
              echo -e "${RED}ERROR${NC}: folder '$DATA_PATH' does not exist. Can not continue.\n"
              exit 1
            fi
        # If the path is relative
        else
            if [ ! -d "$basedir/$DATA_PATH" ]; then
              echo -e "${RED}ERROR${NC}: folder '$basedir/${DATA_PATH}' does not exist. Can not continue.\n"
              exit 1
            else
              DATA_PATH="$(cd "$basedir/$DATA_PATH" && pwd)"
            fi
            echo "$DATA_PATH"
        fi
    fi

    # Activate Fed-BioMed GUI environment
    source ./scripts/fedbiomed_environment gui

    # Install npm modules
    echo -e "${YLW}INFO${NC}: Controlling react bundle and modules"
    cd ./gui/ui

    # Create bundle if there is no build directory/node_modules or recreate is active
    if  [ ! -d "$basedir/gui/ui/node_modules" ] || [ ! -d "$basedir/var/gui-build" ] || [ -n "$RECREATE" ];then
        echo -e "${YLW}INFO${NC}: Installing npm modules"
        npm install || exit

        echo -e "${YLW}INFO${NC}: Building Fed-BioMed GUI"
        npm run build || exit

        if [ -d "$basedir/var/gui-build" ];then
          rm -Rf "$basedir/var/gui-build";
        fi

        mv "$basedir/gui/ui/build/" "$basedir/var/gui-build"
    fi

    cd ../server
    # Starting flask
    echo -e "${YLW}INFO:${NC} Starting Flask Server and API services...."
    FEDBIOMED_ROOT="$basedir" \
      NODE_CONFIG_FILE="$CONFIG_FILE" \
      BUILD_DIR="$basedir/var/gui-build" \
      DATA_PATH="$DATA_PATH" \
      HOST="$GUI_HOST" \
      PORT="$GUI_PORT" \
      DEBUG="$GUI_DEBUG" \
      FLASK_ENV="development" \
      python app.py
}

case $1 in

    network)
        source ./scripts/fedbiomed_environment network
        cd ./envs/development/docker
        #
        case $2 in
            stop)
                docker-compose down
            ;;
            *)
                CONTAINER_UID=$(id -u) CONTAINER_GID=$(id -g) \
                             CONTAINER_USER=$(id -un) CONTAINER_GROUP=$(id -gn) \
                             docker-compose build restful mqtt
                docker-compose up -d restful mqtt
                ;;
        esac
        ;;
    gui)
        while true ; do
            case $2 in
              config|--config|-c)
                    if [ $# -lt 3 ] ; then
                        echo -e "${RED}ERROR${NC}: missing config file name"
                        exit 1
                    fi
                    CONFIG_FILE=$3
                    shift
                    shift
              ;;
              data-folder|--data-folder|-df)
                  if [ $# -lt 3 ] ; then
                      echo -e "${RED}ERROR${NC}: missing data folder path"
                      exit 1
                  fi
                  DATA_PATH="$3"
                  shift
                  shift
                  ;;
              port|--port |-p)
                  GUI_PORT="$3"
                  shift
                  shift
                  ;;
              host|--host|-h)
                  GUI_HOST="$3"
                  shift
                  shift
                  ;;
              recreate | --recreate | -rc )
                  RECREATE=True
                  shift
                  ;;
              debug|--debug|-dbg)
                  GUI_DEBUG=True
                  shift
                  ;;
              *)
                  break
                  ;;
            esac
        done
        case $2 in
            start)
                start_gui
                ;;
            *)
              echo -e "${RED}ERROR:${NC}: Node GUI command should be used with start. Please make sure that your command is correct"
              exit 1
              ;;
        esac
      ;;
    node)

        while true ; do
            case $2 in
                # handle optional parameters : config file, network ip, model approve and allow default models
                config)
                    if [ $# -lt 3 ] ; then
                        echo "ERROR: missing config file name"
                        exit 1
                    fi
                    export CONFIG_FILE=$3
                    shift
                    shift
                ;;
                ip_address)
                    if [ $# -lt 3 ] ; then
                        echo "ERROR: missing network ip"
                        exit 1
                    fi
                    IP_ADDRESS=$3
                    shift
                    shift
                ;;
                enable-model-approval|--enable-model-approval|-emp)
                    export ENABLE_MODEL_APPROVAL=True
                    shift
                ;;
                disable-model-approval|--disable-model-approval|-dmp)
                    export ENABLE_MODEL_APPROVAL=False
                    shift
                ;;
                allow-default-models|--allow-default-models|-adm )
                    export ALLOW_DEFAULT_MODELS=True
                    shift
                ;;
                disable-default-models|--disable-default-models|-ddm )
                    export ALLOW_DEFAULT_MODELS=False
                    shift
                ;;

                *)
                    break
                ;;
            esac
        done

        # pass remaining params to launched script
        if [ $# -ge 2 ]
        then
            export PARAMS=${@:3:$#-2}
        else
            export PARAMS=
        fi

        # TODO : better test with python module loading attempt and try/except
        if [ -f "./fedbiomed/node/cli.py" ]
        then
            case $2 in

                list|--list|-l)
                    source ./scripts/fedbiomed_environment node $IP_ADDRESS
                    python -m fedbiomed.node.cli --list $PARAMS
                    ;;

                del|delete|--del|--delete|-d)
                    source ./scripts/fedbiomed_environment node $IP_ADDRESS
                    python -m fedbiomed.node.cli --delete $PARAMS
                    ;;

                del-all|delete-all|--del-all|--delete-all|-da)
                    source ./scripts/fedbiomed_environment node $IP_ADDRESS
                    python -m fedbiomed.node.cli --delete-all $PARAMS
                    ;;

                delete-mnist|--delete-mnist|-dm)
                    source ./scripts/fedbiomed_environment node $IP_ADDRESS
                    python -m fedbiomed.node.cli --delete-mnist $PARAMS
                    ;;

                add|--add|-a)
                    source ./scripts/fedbiomed_environment node $IP_ADDRESS
                    python -m fedbiomed.node.cli --add $PARAMS
                    ;;

                add-mnist|--add-mnist|-am)
                    source ./scripts/fedbiomed_environment node $IP_ADDRESS
                    python -m fedbiomed.node.cli --add-mnist $PARAMS
                    ;;

                add-dataset-from-file|--add-dataset-from-file|-adff)
                    source ./scripts/fedbiomed_environment node $IP_ADDRESS
                    python -m fedbiomed.node.cli -adff $PARAMS
                    ;;

                register-model|--register-model|-rml)
                    source ./scripts/fedbiomed_environment node $IP_ADDRESS
                    python -m fedbiomed.node.cli --register-model $PARAMS
                    ;;

                update-model|--update-model|-uml)
                    source ./scripts/fedbiomed_environment node $IP_ADDRESS
                    python -m fedbiomed.node.cli --update-model $PARAMS
                    ;;

                list-models|--list-models|-lms)
                    source ./scripts/fedbiomed_environment node $IP_ADDRESS
                    python -m fedbiomed.node.cli --list-models $PARAMS
                    ;;

                delete-model|--delete-model|-dml)
                    source ./scripts/fedbiomed_environment node $IP_ADDRESS
                    python -m fedbiomed.node.cli --delete-model $PARAMS
                    ;;

                start|--start|-s)
                    #export MQTT_BROKER=localhost
                    #export MQTT_BROKER_PORT=1883
                    #export UPLOADS_URL='http://localhost:8844/upload/'
                    source ./scripts/fedbiomed_environment node $IP_ADDRESS
                    python -m fedbiomed.node.cli --start $PARAMS
                    ;;
                *)
                    echo "please run node with add or start option (full help with -h)"
                    exit -1
                    ;;
            esac
        else
            echo "INFO: no fedbiomed.node.cli yet in this version, skipping command"
        fi
        ;;

    researcher)
        #export MQTT_BROKER=localhost
        #export MQTT_BROKER_PORT=1883
        #export UPLOADS_URL='http://localhost:8844/upload/'

        while true ; do
            case $2 in
                ip_address)
                    if [ $# -lt 3 ] ; then
                        echo "ERROR: missing network ip"
                        exit 1
                    fi
                    IP_ADDRESS=$3
                    shift
                    shift
                ;;
                *)
                    break
                ;;
            esac
        done

        source ./scripts/fedbiomed_environment researcher $IP_ADDRESS
        cd notebooks

        # Windows WSL and others cannot handle using redirect file for securing notebook launch
        # https://jupyter-notebook.readthedocs.io/en/stable/config.html (section NotebookApp.use_redirect_file)
        NB_OPTS=
        if [ -n "$(uname -r | egrep -i 'microsoft|wsl')" ]
        # case if windows WSL is used
        then
            NB_OPTS='--NotebookApp.use_redirect_file=false'
        fi

        jupyter notebook $NB_OPTS
        ;;

    help|-h|--help)
        cat <<EOF
usage: fedbiomed_run network (stop)
       fedbiomed_run researcher [ip_address IP_ADDRESS]
       fedbiomed_run node [config CONFIG_NAME | ip_address IP_ADDRESS | enable-model-approval | disable-model-approval | allow-default-models | disable-default-models ]
                         (start | add | list | delete | add-mnist PATH_TO_DATASET | delete-mnist | list-models | register-model | delete-model | update-model) PARAMS
        febiomed_run gui [data-folder DATAFOLDER | config CONFIG_NAME | host IP_ADDRESS | port PORT | --recreate]
                         (start)

Runs the fedbiomed components after properly initializing the environments.
The component name is mandatory.

network   : run the necessary docker containers (in development mode)
            stop the containers if stop argument is provided

researcher: launch a researcher notebook

            an optional IP_ADDRESS (eg 10.1.2.3 or host.foo) can be used to join the network
                component instead of the default localhost

node      : a second argument is mandatory
            - start : launch a new node
            - add/list/delete deal with dataset
            - add-mnist PATH_TO_DATASET non-interactively adds a mnist dataset
            - add-dataset-from-file PATH_TO_JSON_FILE non-interactively adds a dataset
                described in a json file with the following format

                {
                    "path": "/path/to/dataset",
                    "data_type": "csv|default|images",
                    "description": "arbitrary descrription string",
                    "tags": "comma,separated,list,without,blanks",
                    "name": "arbitrary name string"
                }

            - delete-mnist non-interactively un-registers a mnist dataset
            - delete-all non interactively un-registers all node datasets

            - register-model  | --register-model    : To register new model files
            - update-model    | --update-model      : To update registered models

            an optional config file CONFIG_NAME can be given it will be used instead of the default one (config.ini)

            an optional IP_ADDRESS can be used to join the network component instead of
                the default localhost

            optional additional PARAMS are passed to fedbiomed

            Option that should be used with start or add command to manage node modes.

            - enable-model-approval     | --enable-model-approval   : to enable model approval mode
            - allow-default-models      | --allow-default-models    : to allow default model for model approval mode
            - disable-model-approval    | --disable-model-approval  : to disable model approval mode
            - disable-default-models    | --disable-default-models  : to disable default models for model approval mode
gui       :
            Options:
            - data-folder | --data-folder | -df  [<path>]   : Folder that data files are stored, by default script will
                                                              look for `data` in Fed-BioMed directory
            - config      | --config      | -c   [<config>] : Name of the node's config file. GUI will be configured
                                                              based on given config file. By default, `config_node.ini`.
                                                              If config file doesn't exist script will raise an error.
            - port        | --port        | -p   [<port>]   : HTTP port that GUI will be served. Default is `8484`
            - host        | --host        | -h   [<host>]   : HTTP host that GUI will be served, Default is `localhost`
            - recreate    | --recreate    | -rc             : Flag that indicates, UI will be rebuilt while launching
                                                              the GUI. Use this option if you have updated UI scripts.
            - debug       | --debug       | -dbg            : Flag that will start Flask (Server) in debug mode.

            Commands:
            - start: Launches the Node GUI with given options.

EOF
        ;;

    *)
        echo "Please specify the component you want to run between: network, node, researcher, gui"
        exit -1
        ;;
esac
