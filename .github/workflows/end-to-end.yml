name: New End-to-End Test
run-name: fedbiomed-e2e-tests
permissions: write-all
on:
  schedule:
    - cron: '30 1 * * *'

  workflow_dispatch:

  push:
    branches:
      - 'develop'
      - 'master'
      - 'feature/end-to-end-test-machinery'

jobs:
  e2e-test-auto:
    name: e2e tests
    strategy:
      fail-fast: false # Importance ?
      matrix:
        os: [ubuntu-22-04, fedora38, macosx-m1]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout of head
        id: e2e-checkout
        uses: actions/checkout@v3

      - name: Clear environment and re-install
        id: env-reinstall
        run: |
          source ~/.bashrc
          conda env remove --name fedbiomed-researcher
          conda env remove --name fedbiomed-node
          conda env --update -f ./envs/development/conda/fedbiomed-researcher.yaml
          conda env --update -f ./envs/development/conda/fedbiomed-node.yaml
        shell: bash -l {0}

      - name: Run end-to-end tests
        id: e2e-tests-with-pytest
        run: |
          echo "Launching end-to-end tests" # to check from time to time
          PYTHONPATH=${PYTHONPATH:-$PWD} conda run -n fedbiomed-researcher pytest -rf -s -v tests/end2end/e2e_*.py
        shell: bash -l {0}

