# Configuring Development Environment

This article is written to guide developers to create development environment for developers. This guide can also be used to build Fed-BioMed software from its source.


This article will guide you to:

- clone Fed-BioMed source repository.
- setup a recommended tool to manage different Python versions.
- setup some optional tools to manage isolated python environments such as `conda` and `virtualenv`.
- setup poetry to manage dependencies and build operations, and it usage.


## Clone the repository
The first step is to clone the repository please go to (Fed-BioMed GitHub Repository)[https://github.com/fedbiomed/fedbiomed] and clone it your local environment.

```
git clone https://github.com/fedbiomed/fedbiomed <path-to-clone>
cd <path-to-clone>
```


## Compatible Python version

Before start using Fed-BioMed or start developing on Fed-BioMed please make sure that required Python version is installed on your machine. Please go to `pyrpoject.toml` file located in the root of Fed-BioMed clone, and check required Python version interval.

!!! note "Tool for different Python version"

    You can use the tool `pyenv` to be able to instal specific Python versions into your local environment
    ```
    pyenv install 3.11
    pyend global 3.11
    ```
    To code above will install latest Python 3.11, and activate this version globally.


## Install recommended tools to manage development environment

### Use a virtual environments to manage dependencies

Using virtual environments will allow you to isolate your Fed-BioMed development environment from your other projects. There, you have of course several options. You can use `virtualenv` or `conda` or any other compatible Python virtual environment tools.

While `conda` allows also installing a specified Python version, `virtualenv` requires that the Python, and Pip is already installed. Therefore, if `conda` is used using another tools like `pyenv` is not required to be installed and used to manage Python versions. However, if `virtualenv` is preferred, then, using tools `pyenv` to install required Python version is recommended.

#### Case: virtualenv
Once required Python version installed and activated `virtualenv` can be installed.

```
pip install virtualenv
```

The advantage of `virtualenv` is that it keeps all project dependencies within your project folder. Please go to Fed-BioMed project root (Fed-BioMed) clone and execute following command.

```
cd <path-to-fedbiomed-clone>
python -m venv dev-env
```

The command above will generate `dev-env` folder in the project folder where all the project dependencies are kept.

To activate the environment you can execute following command from project root directory.

```
source dev-env/bin/activate
```

You can also use default naming convention `.venv` for virtual environment name.

#### Case: Conda

`conda` can install Python version directly in the environment that is created. The command below will create a virtual environment and install the specified Python version.

```
conda env creaate --name fedbiomed-dev python=3.11
conda activate fedbiomed-dev
```


### Install Poetry

Once virtual environments are set `poetry` package manager can be installed via `PyPI`.

```
pip install poetry
```

The command above will install Poetry in the active `conda` environment or in active `pyenv` if it is used for managing Python versions.


## Using poetry

Poetry is a tool to manage dependencies of a Python project, and build the python package from its source through instructions given in `pyproject.toml` located in the root directory of the project. Project build settings and dependencies can be configured form `pyproject.toml` file.

Once poetry is installed dependencies can be installed through the following command. If there is no lock file generated by poetry it will resolve all the dependencies defined in `pyproject.toml`

```
poetry install
```

The following command will install all dependency groups except the dependencies that are depended as extra. There are also other installation options such selection of specific groups or extra dependencies. Please see `poetry install --help` and `pyproject.toml` file for more information.

This command will automatically detect the environment that used currently and install all dependencies in it. For example, if conda env is activated and there is no `.venv` folder in root directory of the project, all dependencies will installed within the `conda` environment. However, if another virtual environment is activated, or if `.venv` folder is existing poetry will install dependencies within that environment.

If there is no virtual environment created poetry will will create a default virtual environment using python's `virtualenv` in `.venv`


### What about instant changes in source code?

Poetry automatically add package source to your environment that makes `fedbiomed` module accessible from Python interpreter. It also handles instant changes in the source code. If a new module is added or a module is edited poetry will automatically make changes available within the environment currently used. It means there is no need to install or rebuild `fedbiomed` package.

!!! warning "Important"
    You should never install `fedbiomed` from `pip` in your development environment. This my interrupt to access current source code changes in your development environment.

### Add new module

New packages can be added through `pyproject.toml`, or using the command `poetry add`. Please see `peotry add --help` for detailed usage instructions.

Once a new package added via `pyproject.toml` it may be required to run `poetry lock --no-update` to resolve the dependencies, then, execute `poetry install` to update packages and install missing ones.

### For more

Please visit `poetry` documentation for more information and usage details.


## Post actions

To verify your installation please run `pytest tests` to make sure there is no missing module in your environment.

## Trouble shooting

### Error on MacOS: `_lzma` module not found

If you are using MacOS and installing Python versions through `pyenv` you may have some missing packages in your environment. `ModuleNotFoundError: No module named '_lzma'` is one of them. If you faced this error please install `brew install xz`, and reinstall python version `pyenv insntall <version>`.


